{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I've read the spec and then looked at the c-toxcore implementation to double check if I understood it correctly, looks like I've got it right.\r\n\r\n### The issue\r\nThe thing that bothers me a lot about onion path construction and handling in current form is that **each node** that participates in onion path (including initiator and receiver) **knows exactly where** in the onion path it is located.\r\n\r\nIn other words, if my machine relays traffic, I know for sure whether I'm the first node in onion path (receives data from initiator), second node or the third node (which sends data to the receiver).\r\n\r\nThis knowledge escalates #61 and makes it even easier to accomplish that I have thought it would be.\r\n\r\n### Potential solution\r\nEssentially, I'd prefer to have onion path in which no one except initiator and receiver knows who they are.\r\n\r\nI'm thinking about not nesting each encrypted layer into another, but rather concatenate them. This way we can just unwrap the beginning, look if it was targeted to us, if not - add encrypted address to the end and forward packet further. Using this technic no node in the middle will know how many addresses were unwrapped before it and how many left after.\r\n\r\n### Concerns with solution\r\nI'm not crypto expert, so I'm not sure if lack of wrapping into multiple encrypted layers reduces effective security. Especially for the address appended to the end of the packet that moves unchanged encrypted pieces closer to the beginning of the packet. It feels like it shouldn't (assuming secure encryption method and only protection against limited observer that can't observer the whole onion path), but would be nice if someone can confirm this.\r\n\r\n### Further thoughts\r\nThis approach would allow us to even hide exact number of hops used in onion path from everyone except receiver if we want to do so (we can append some random bytes to payload and only receiver will not that). Also implementation will become much smaller and more generic than current hardcoded `handle_send_1`, `handle_send_2` and the likes.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "The onion doesn't work in tox the way it works in Tor. \r\n\r\nIt's a mistake to try to coerce it to function like that.\r\n\r\n(This is not a argument against your concern, you're completely correct. It's an argument against the onion)",
            "created_at": "2017-09-23T17:09:23Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331652387",
            "id": 331652387,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTY1MjM4Nw==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331652387/reactions"
            },
            "updated_at": "2017-09-23T17:09:23Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331652387",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/243408?v=4",
                "events_url": "https://api.github.com/users/GrayHatter/events{/privacy}",
                "followers_url": "https://api.github.com/users/GrayHatter/followers",
                "following_url": "https://api.github.com/users/GrayHatter/following{/other_user}",
                "gists_url": "https://api.github.com/users/GrayHatter/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/GrayHatter",
                "id": 243408,
                "login": "GrayHatter",
                "node_id": "MDQ6VXNlcjI0MzQwOA==",
                "organizations_url": "https://api.github.com/users/GrayHatter/orgs",
                "received_events_url": "https://api.github.com/users/GrayHatter/received_events",
                "repos_url": "https://api.github.com/users/GrayHatter/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/GrayHatter/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/GrayHatter/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/GrayHatter"
            }
        },
        {
            "author_association": "NONE",
            "body": "Sorry for possibly mixing Tor's and Tox's terms or something, I've read a few different specs recently and might get confused in the process.",
            "created_at": "2017-09-23T17:30:00Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331655415",
            "id": 331655415,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTY1NTQxNQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331655415/reactions"
            },
            "updated_at": "2017-09-23T17:30:00Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331655415",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/928965?v=4",
                "events_url": "https://api.github.com/users/nazar-pc/events{/privacy}",
                "followers_url": "https://api.github.com/users/nazar-pc/followers",
                "following_url": "https://api.github.com/users/nazar-pc/following{/other_user}",
                "gists_url": "https://api.github.com/users/nazar-pc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/nazar-pc",
                "id": 928965,
                "login": "nazar-pc",
                "node_id": "MDQ6VXNlcjkyODk2NQ==",
                "organizations_url": "https://api.github.com/users/nazar-pc/orgs",
                "received_events_url": "https://api.github.com/users/nazar-pc/received_events",
                "repos_url": "https://api.github.com/users/nazar-pc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/nazar-pc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/nazar-pc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/nazar-pc"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "* Saturday, 2017-09-23 at 12:10 +0000 - Nazar Mokrynskyi <notifications@github.com>:\n\n>The thing that bothers me a lot about onion path construction and \n>handling in current form is that **each node** that participates in \n>onion path (including initiator and receiver) **knows exactly where** \n>in the onion path it is located.\n\nYes. This does sometimes make life easier for an attacker, but are there \nany attacks which are possible with this fact which would be rendered \nimpossible by adjusting the protocol to hide this information? I don't \nsee any. Note in particular that if an attacker controls the destination \nof a request and another node in the path, they can see if that node is \nthe middle or exit node by observing the IP addresses of neighbours.\n",
            "created_at": "2017-09-23T18:28:13Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331661060",
            "id": 331661060,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTY2MTA2MA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661060/reactions"
            },
            "updated_at": "2017-09-23T18:28:13Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661060",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/590069?v=4",
                "events_url": "https://api.github.com/users/zugz/events{/privacy}",
                "followers_url": "https://api.github.com/users/zugz/followers",
                "following_url": "https://api.github.com/users/zugz/following{/other_user}",
                "gists_url": "https://api.github.com/users/zugz/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zugz",
                "id": 590069,
                "login": "zugz",
                "node_id": "MDQ6VXNlcjU5MDA2OQ==",
                "organizations_url": "https://api.github.com/users/zugz/orgs",
                "received_events_url": "https://api.github.com/users/zugz/received_events",
                "repos_url": "https://api.github.com/users/zugz/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zugz/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zugz/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zugz"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "* Saturday, 2017-09-23 at 10:09 -0700 - Gregory Mullen <notifications@github.com>:\n\n>The onion doesn't work in tox the way it works in Tor.\n>\n>It's a mistake to try to coerce it to function like that.\n\nThis is off-topic, but it occurs to me that actually Tox's use-case is \nstrongly analogous to that of Tor's hidden servers. In both cases the \nproblem is to allow Alice to anonymously initiate communication with Bob \nbased only on publically available information about Bob (the ToxID for \nTox; a .onion address for Tor), without leaking Bob's location.\n\nTox's current solution is very different from Tor's, but it isn't clear \nto me that it would be a mistake to take lessons from Tor.\n",
            "created_at": "2017-09-23T18:34:17Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331661480",
            "id": 331661480,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTY2MTQ4MA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661480/reactions"
            },
            "updated_at": "2017-09-23T18:34:17Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661480",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/590069?v=4",
                "events_url": "https://api.github.com/users/zugz/events{/privacy}",
                "followers_url": "https://api.github.com/users/zugz/followers",
                "following_url": "https://api.github.com/users/zugz/following{/other_user}",
                "gists_url": "https://api.github.com/users/zugz/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zugz",
                "id": 590069,
                "login": "zugz",
                "node_id": "MDQ6VXNlcjU5MDA2OQ==",
                "organizations_url": "https://api.github.com/users/zugz/orgs",
                "received_events_url": "https://api.github.com/users/zugz/received_events",
                "repos_url": "https://api.github.com/users/zugz/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zugz/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zugz/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zugz"
            }
        },
        {
            "author_association": "NONE",
            "body": "Agree, it might not completely eliminate some attacks, but I'm throwing concerns to the public to discuss whether this is something that needs to be fixed i future or not.\r\nAlso it is interesting how combining hardening of this aspect and https://github.com/TokTok/c-toxcore/issues/596 would work together.\r\nThere are always attacks that are impossible to completely eliminate, but sometimes very possible to make them practically out of reach for most attackers except powerful governments.",
            "created_at": "2017-09-23T18:37:07Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331661667",
            "id": 331661667,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTY2MTY2Nw==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661667/reactions"
            },
            "updated_at": "2017-09-23T18:37:07Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331661667",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/928965?v=4",
                "events_url": "https://api.github.com/users/nazar-pc/events{/privacy}",
                "followers_url": "https://api.github.com/users/nazar-pc/followers",
                "following_url": "https://api.github.com/users/nazar-pc/following{/other_user}",
                "gists_url": "https://api.github.com/users/nazar-pc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/nazar-pc",
                "id": 928965,
                "login": "nazar-pc",
                "node_id": "MDQ6VXNlcjkyODk2NQ==",
                "organizations_url": "https://api.github.com/users/nazar-pc/orgs",
                "received_events_url": "https://api.github.com/users/nazar-pc/received_events",
                "repos_url": "https://api.github.com/users/nazar-pc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/nazar-pc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/nazar-pc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/nazar-pc"
            }
        },
        {
            "author_association": "NONE",
            "body": "I've been thinking about this issue and some others for my project and come up with early protocol framework that hides more information than Tox's onion currently (fixes this particular issue) and is much simpler than Tor's onion implementation. It also is more uniform than Tox's routing handling, so that there will be no need to create separate functions for different node positions in onion path.\r\nIf someone have a bit of free time I'd be thankful for any feedback: https://github.com/nazar-pc/ronion/blob/master/spec.md\r\nImplementation doesn't exist yet.\r\n\r\nUPD: Implementation is already in the repository.",
            "created_at": "2017-09-25T12:16:24Z",
            "html_url": "https://github.com/TokTok/spec/issues/62#issuecomment-331862844",
            "id": 331862844,
            "issue_url": "https://api.github.com/repos/TokTok/spec/issues/62",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTg2Mjg0NA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331862844/reactions"
            },
            "updated_at": "2017-09-29T02:46:21Z",
            "url": "https://api.github.com/repos/TokTok/spec/issues/comments/331862844",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/928965?v=4",
                "events_url": "https://api.github.com/users/nazar-pc/events{/privacy}",
                "followers_url": "https://api.github.com/users/nazar-pc/followers",
                "following_url": "https://api.github.com/users/nazar-pc/following{/other_user}",
                "gists_url": "https://api.github.com/users/nazar-pc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/nazar-pc",
                "id": 928965,
                "login": "nazar-pc",
                "node_id": "MDQ6VXNlcjkyODk2NQ==",
                "organizations_url": "https://api.github.com/users/nazar-pc/orgs",
                "received_events_url": "https://api.github.com/users/nazar-pc/received_events",
                "repos_url": "https://api.github.com/users/nazar-pc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/nazar-pc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/nazar-pc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/nazar-pc"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/TokTok/spec/issues/62/comments",
    "created_at": "2017-09-23T12:10:54Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/TokTok/spec/issues/62/events",
    "html_url": "https://github.com/TokTok/spec/issues/62",
    "id": 260003617,
    "labels": [],
    "labels_url": "https://api.github.com/repos/TokTok/spec/issues/62/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyNjAwMDM2MTc=",
    "number": 62,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/TokTok/spec/issues/62/reactions"
    },
    "repository_url": "https://api.github.com/repos/TokTok/spec",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/TokTok/spec/issues/62/timeline",
    "title": "Concern about onion path structure disclosure",
    "updated_at": "2017-09-29T02:46:21Z",
    "url": "https://api.github.com/repos/TokTok/spec/issues/62",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/928965?v=4",
        "events_url": "https://api.github.com/users/nazar-pc/events{/privacy}",
        "followers_url": "https://api.github.com/users/nazar-pc/followers",
        "following_url": "https://api.github.com/users/nazar-pc/following{/other_user}",
        "gists_url": "https://api.github.com/users/nazar-pc/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/nazar-pc",
        "id": 928965,
        "login": "nazar-pc",
        "node_id": "MDQ6VXNlcjkyODk2NQ==",
        "organizations_url": "https://api.github.com/users/nazar-pc/orgs",
        "received_events_url": "https://api.github.com/users/nazar-pc/received_events",
        "repos_url": "https://api.github.com/users/nazar-pc/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/nazar-pc/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/nazar-pc/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/nazar-pc"
    }
}